{
  "hash": "016377b4dff4b3b5d1b2b63255c2e708",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Next leveling RNAseq\"\ndescription: \"Minion\"\ncategories: [oyster, chile]\n#citation: \ndate: 08-04-2025\nimage: http://gannet.fish.washington.edu/seashell/snaps/Monosnap_project-ostrea-chil__RStudio_Server_2025-08-04_20-31-31.png # finding a good image\n\nauthor:\n  - name: Steven Roberts\n    url: \n    orcid: 0000-0001-8302-1138\n    affiliation: Professor, UW - School of Aquatic and Fishery Sciences\n    affiliation-url: https://robertslab.info\n  #url:  # self-defined\ndraft: false # setting this to `true` will prevent your post from appearing on your listing page until you're ready!\nformat:\n  html:\n    code-fold: FALSE\n    code-tools: true\n    code-copy: true\n    highlight-style: github\n    code-overflow: wrap\n#runtime: shiny\n---\n\n\n\nStarted over with merged genome....\n\n# minimap2\n\n``` bash\neval \"$(/opt/anaconda/anaconda3/bin/conda shell.bash hook)\"\nconda activate\n\n# Set number of threads\nthreads=42\n\n# Set paths\nref_genome=\"../data/merged_out.fasta.TBtools.fa\"\ninput_dir=\"../output/02-RNAseq\"\noutput_dir=\"../output/04-align-v1\"\n\n# Loop over each FASTQ file\nfor fq in ${input_dir}/*.fastq.gz; do\n  # Extract sample name (e.g., Pum_barcode02 from Pum_barcode02_combined.fastq.gz)\n  sample=$(basename \"$fq\" .fastq.gz)\n\n  echo \"Processing $sample...\"\n\n  # Run minimap2 and samtools sort\n  minimap2 -ax splice -k14 --MD -t $threads \"$ref_genome\" \"$fq\" | \\\n    samtools sort -@ $threads -o \"${output_dir}/${sample}.sorted.bam\"\n\n  # Index the sorted BAM\n  samtools index \"${output_dir}/${sample}.sorted.bam\"\ndone\n```\n\n# Stringtie\n\n\n\n``` bash\nmkdir -p ../output/04-align-v1/stringtie_out\n\nfor bam in ../output/04-align-v1/*combined.sorted.bam; do\n    sample=$(basename \"$bam\" _combined.sorted.bam)\n    /home/shared/stringtie-2.2.1.Linux_x86_64/stringtie \"$bam\" \\\n        -L \\\n        -o ../output/04-align-v1/stringtie_out/${sample}.gtf \\\n        -p 32 \\\n        -v\ndone\n```\n``` bash\nls ../output/04-align-v1/stringtie_out/*.gtf > ../output/04-align-v1/stringtie_out/mergelist.txt\n\n/home/shared/stringtie-2.2.1.Linux_x86_64/stringtie --merge \\\n    -L \\\n    -G ../data/GN.gene.gtf \\\n    -o ../output/04-align-v1/stringtie_out/merged.gtf \\\n    ../output/04-align-v1/stringtie_out/mergelist.txt\n```\n\n\n``` bash\nmkdir -p ../output/04-align-v1/stringtie_quant\n\nfor bam in ../output/04-align-v1/*combined.sorted.bam; do\n    sample=$(basename \"$bam\" _combined.sorted.bam)\n    /home/shared/stringtie-2.2.1.Linux_x86_64/stringtie \"$bam\" \\\n        -L \\\n        -e \\\n        -B \\\n        -G ../output/04-align-v1/stringtie_out/merged.gtf \\\n        -o ../output/04-align-v1/stringtie_quant/${sample}.gtf\ndone\n```\n\n# matrix\n\n\n``` bash \npython /home/shared/stringtie-2.2.1.Linux_x86_64/prepDE.py \\\n-i ../output/04-align-v1/stringtie_quant/samplelist.txt \\\n-g ../output/04-align-v1/stringtie_quant/gene_count_matrix.csv \\\n-t ../output/04-align-v1/stringtie_quant/transcript_count_matrix.csv\n```\n## normalize matrix\n\n``` r\nlibrary(DESeq2)\n\n# Load raw counts\ngene_counts <- read.csv(\"../output/04-align-v1/stringtie_quant/gene_count_matrix.csv\", row.names = 1)\n\n# Make sample metadata\nsample_info <- data.frame(\n  row.names = colnames(gene_counts),\n  condition = c(\"A\", \"A\", \"A\",\"A\", \"B\", \"B\", \"B\",\"B\",\"C\",\"C\", \"C\", \"C\")  # example\n)\n\n# DESeq2 object and normalization\ndds <- DESeqDataSetFromMatrix(countData = gene_counts, colData = sample_info, design = ~ condition)\ndds <- DESeq(dds)\nnorm_counts <- counts(dds, normalized = TRUE)\n```\n\n# limma (differential expression)\n\n``` r \nlibrary(limma)\nlibrary(tidyverse)\n\n# Prepare expression matrix (genes x samples)\nexpr <- as.matrix(norm_counts)\n\n# Create design matrix\ngroup <- factor(case_when(\n  str_detect(colnames(expr), \"^Pum\") ~ \"Pum\",\n  str_detect(colnames(expr), \"^Qui\") ~ \"Qui\",\n  str_detect(colnames(expr), \"^Rio\") ~ \"Rio\"\n))\n\ndesign <- model.matrix(~ 0 + group)\ncolnames(design) <- levels(group)\n\n# Fit linear model\nfit <- lmFit(expr, design)\n\n# Create contrast for all pairwise comparisons\ncontrast_matrix <- makeContrasts(\n  Pum_vs_Qui = Pum - Qui,\n  Pum_vs_Rio = Pum - Rio,\n  Qui_vs_Rio = Qui - Rio,\n  levels = design\n)\n\nfit2 <- contrasts.fit(fit, contrast_matrix)\nfit2 <- eBayes(fit2)\n\n# Get top DE genes across comparisons\ntop_table <- topTable(fit2, coef = \"Qui_vs_Rio\", number = 20)\nhead(top_table)\n```\n\n## Get all Contrast \n\n\n``` r \n# Get all contrast names\ncontrast_names <- colnames(fit2$contrasts)\n\n# Extract all DEGs per contrast\ndeg_list <- lapply(contrast_names, function(contrast) {\n  tt <- topTable(fit2, coef = contrast, number = Inf, sort.by = \"P\")  # all genes\n  tt$gene_id <- rownames(tt)\n  tt$contrast <- contrast\n  tt\n})\n\n# Combine into one long data frame\nall_degs <- bind_rows(deg_list)\n```\n\n\n``` r \nsig_degs %>%\n  count(contrast)\n```\n\n![](http://gannet.fish.washington.edu/seashell/snaps/Monosnap_project-ostrea-chil__RStudio_Server_2025-08-04_20-37-58.png)\n``` r\nlibrary(UpSetR)\n\n# Make DEG sets by contrast\ndeg_sets <- sig_degs %>%\n  group_by(contrast) %>%\n  summarize(genes = list(gene_id)) %>%\n  deframe()\n\nupset(fromList(deg_sets), nsets = length(deg_sets), order.by = \"freq\")\n```\n\n![](http://gannet.fish.washington.edu/seashell/snaps/Monosnap_project-ostrea-chil__RStudio_Server_2025-08-04_20-39-02.png)\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n|gene_id                     |contrast   |X1                                                |X2                              |   X3|  X4|  X5| X6|    X7|    X8|  X9| X10|     X11|   X12|\n|:---------------------------|:----------|:-------------------------------------------------|:-------------------------------|----:|---:|---:|--:|-----:|-----:|---:|---:|-------:|-----:|\n|MSTRG.16036                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.28403                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.24262                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.5573                  |Pum_vs_Qui |MSTRG.5573::Chromosome_1B:170312406-170333998(+)  |sp&#124;Q5TZA2&#124;CROCC_HUMAN | 48.0|  98|  48|  2|  4152|  4439|  22| 118| 0.0e+00|  77.0|\n|MSTRG.5573                  |Pum_vs_Qui |MSTRG.5573::Chromosome_1B:170312557-170362327(+)  |sp&#124;Q5TZA2&#124;CROCC_HUMAN | 48.0|  98|  48|  2|  4001|  4288|  22| 118| 0.0e+00|  77.0|\n|MSTRG.6914                  |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.3067                  |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.6508                  |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.1953                  |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.29102                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.21000&#124;GN016607.1 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.31664                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.5499                  |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.27106                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.19435                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.28904                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.26734                 |Pum_vs_Qui |MSTRG.26734::Chromosome_7B:129126903-129127351(.) |sp&#124;Q9BXX0&#124;EMIL2_HUMAN | 40.5|  74|  42|  1|   431|   210| 906| 977| 4.5e-06|  48.5|\n|MSTRG.21022                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.30588                 |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.9920                  |Pum_vs_Qui |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.6508                  |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.28403                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.3067                  |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.1953                  |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.17542                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.29102                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.25453                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.21000&#124;GN016607.1 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.5075                  |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.5929                  |Pum_vs_Rio |MSTRG.5929::Chromosome_1B:186679521-186686006(+)  |sp&#124;Q6DIY8&#124;M17L2_XENTR | 38.4| 198| 116|  4|  5682|  6266|   2| 196| 0.0e+00| 124.0|\n|MSTRG.31664                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.5499                  |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.27111                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.6115                  |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.26734                 |Pum_vs_Rio |MSTRG.26734::Chromosome_7B:129126903-129127351(.) |sp&#124;Q9BXX0&#124;EMIL2_HUMAN | 40.5|  74|  42|  1|   431|   210| 906| 977| 4.5e-06|  48.5|\n|MSTRG.31461                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.18807                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.30588                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.2111                  |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.9920                  |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.21438                 |Pum_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.27106                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.16036                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.24262                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.5573                  |Qui_vs_Rio |MSTRG.5573::Chromosome_1B:170312406-170333998(+)  |sp&#124;Q5TZA2&#124;CROCC_HUMAN | 48.0|  98|  48|  2|  4152|  4439|  22| 118| 0.0e+00|  77.0|\n|MSTRG.5573                  |Qui_vs_Rio |MSTRG.5573::Chromosome_1B:170312557-170362327(+)  |sp&#124;Q5TZA2&#124;CROCC_HUMAN | 48.0|  98|  48|  2|  4001|  4288|  22| 118| 0.0e+00|  77.0|\n|MSTRG.17542                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.25471                 |Qui_vs_Rio |MSTRG.25471::Chromosome_7B:80510238-80537915(+)   |sp&#124;A9ULZ2&#124;BIR7B_XENLA | 32.6| 190|  91|  4| 10080| 10538| 154| 343| 0.0e+00| 112.0|\n|MSTRG.25471                 |Qui_vs_Rio |MSTRG.25471::Chromosome_7B:80510238-80537915(+)   |sp&#124;A9ULZ2&#124;BIR7B_XENLA | 32.6| 190|  91|  4| 10080| 10538| 154| 343| 0.0e+00| 112.0|\n|MSTRG.24917                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.10366                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.25453                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.27117                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.5075                  |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.27111                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.24906                 |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.5929                  |Qui_vs_Rio |MSTRG.5929::Chromosome_1B:186679521-186686006(+)  |sp&#124;Q6DIY8&#124;M17L2_XENTR | 38.4| 198| 116|  4|  5682|  6266|   2| 196| 0.0e+00| 124.0|\n|MSTRG.6115                  |Qui_vs_Rio |NA                                                |NA                              |   NA|  NA|  NA| NA|    NA|    NA|  NA|  NA|      NA|    NA|\n|MSTRG.22169                 |Qui_vs_Rio |MSTRG.22169::Chromosome_6B:76312513-76318400(-)   |sp&#124;Q8BFQ2&#124;T229B_MOUSE | 60.9| 161|  57|  1|  5323|  5787|   3| 163| 0.0e+00| 208.0|\n\n\n:::\n:::\n\n\n\n\n![Page 1](https://gannet.fish.washington.edu/v1_web/owlshell/bu-github/project-ostrea-chil/output/04-align-v1/DEG_boxplots_page_01.png)\n![Page 2](https://gannet.fish.washington.edu/v1_web/owlshell/bu-github/project-ostrea-chil/output/04-align-v1/DEG_boxplots_page_02.png)\n![Page 3](https://gannet.fish.washington.edu/v1_web/owlshell/bu-github/project-ostrea-chil/output/04-align-v1/DEG_boxplots_page_03.png)",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}